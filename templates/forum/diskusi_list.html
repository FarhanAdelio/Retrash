{% extends 'base.html' %}
{% load static %}

{% block title %}Forum Diskusi - ReTrash{% endblock %}

{% block content %}
<!-- Toast Notification Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toastMessage">Operasi berhasil!</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Forum Header -->
<section class="forum-header position-relative">
    <div class="header-overlay"></div>
    <div class="container position-relative" style="z-index: 2;">
        <div class="row align-items-center py-5">
            <div class="col-lg-8">
                <div class="mb-3" data-aos="fade-right">
                    <span class="badge bg-white text-success px-3 py-2 shadow-sm">
                        <i class="fas fa-comments me-2"></i>Komunitas ReTrash
                    </span>
                </div>
                <h1 class="display-4 fw-bold text-white mb-3" data-aos="fade-right" data-aos-delay="100">
                    Forum Diskusi
                </h1>
                <p class="lead text-white mb-4 opacity-90" data-aos="fade-right" data-aos-delay="200">
                    Diskusikan berbagai topik seputar pengelolaan sampah dan lingkungan bersama komunitas ReTrash
                </p>
                <a href="{% url 'forum:diskusi_baru' %}" class="btn btn-light btn-lg shadow-sm" data-aos="fade-right" data-aos-delay="300">
                    <i class="fas fa-plus-circle me-2"></i>Mulai Diskusi Baru
                </a>
            </div>
            <div class="col-lg-4 text-center d-none d-lg-block" data-aos="fade-left">
                <i class="fas fa-users-line fa-10x text-white opacity-25"></i>
            </div>
        </div>
    </div>
</section>

<div class="container py-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Search & Filter -->
            <div class="card border-0 shadow-sm mb-4 search-card">
                <div class="card-body p-4">
                    <form method="get" class="row g-3">
                        <div class="col-md-10">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-success"></i>
                                </span>
                                <input type="text" name="q" class="form-control border-start-0 ps-0" 
                                       placeholder="Cari topik diskusi..." value="{{ request.GET.q }}"
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Quick Filter Tags -->
                    {% if request.GET.q %}
                    <div class="mt-3">
                        <span class="badge bg-success-subtle text-success me-2">
                            <i class="fas fa-filter me-1"></i>Pencarian: "{{ request.GET.q }}"
                            <a href="{% url 'forum:list' %}" class="text-success ms-2 text-decoration-none">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Sorting Options -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-list-ul text-success me-2"></i>Semua Diskusi
                        {% if page_obj %}
                        <span class="badge bg-success-subtle text-success rounded-pill">{{ page_obj.paginator.count }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="btn-group shadow-sm" role="group">
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}sort=terbaru" 
                       class="btn btn-sm btn-outline-success {% if current_sort == 'terbaru' or not current_sort %}active{% endif %}">
                        <i class="fas fa-fire me-1"></i>Terbaru
                    </a>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}sort=populer" 
                       class="btn btn-sm btn-outline-success {% if current_sort == 'populer' %}active{% endif %}">
                        <i class="fas fa-star me-1"></i>Populer
                    </a>
                    <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}sort=aktif" 
                       class="btn btn-sm btn-outline-success {% if current_sort == 'aktif' %}active{% endif %}">
                        <i class="fas fa-comment me-1"></i>Aktif
                    </a>
                </div>
            </div>

            <!-- Discussion List -->
            <div class="discussions-list">
                {% for diskusi in object_list %}
                <div class="card border-0 shadow-sm mb-3 discussion-card position-relative" 
                     data-aos="fade-up" 
                     data-aos-delay="{{ forloop.counter0|add:50 }}"
                     data-view-count="{{ diskusi.view_count }}"
                     data-comment-count="{{ diskusi.jumlah_komentar }}">
                    <!-- Trending Badge -->
                    {% if diskusi.view_count > 50 %}
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-danger shadow-sm pulse">
                            <i class="fas fa-fire me-1"></i>Trending
                        </span>
                    </div>
                    {% endif %}
                    
                    <div class="card-body p-4">
                        <div class="d-flex gap-3">
                            <div class="flex-shrink-0">
                                <div class="avatar-wrapper position-relative">
                                    <img src="https://ui-avatars.com/api/?name={{ diskusi.penulis.username }}&background=198754&color=fff&size=56&bold=true" 
                                         alt="{{ diskusi.penulis.username }}" 
                                         class="rounded-circle discussion-avatar">
                                    <span class="avatar-badge"></span>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">
                                        <a href="{% url 'forum:diskusi_detail' diskusi.slug %}" 
                                           class="text-decoration-none text-dark fw-bold discussion-link">
                                            {{ diskusi.judul }}
                                        </a>
                                    </h5>
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-success-subtle text-success rounded-pill">
                                            <i class="far fa-comment me-1"></i>{{ diskusi.jumlah_komentar }}
                                        </span>
                                    </div>
                                </div>
                                <p class="card-text text-muted mb-3" style="font-size: 0.95rem;">
                                    {{ diskusi.isi|striptags|truncatewords:25 }}
                                </p>
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                    <div class="d-flex align-items-center flex-wrap gap-3 text-muted small">
                                        <span class="d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Penulis diskusi">
                                            <i class="fas fa-user-circle me-2 text-success"></i>
                                            <strong>{{ diskusi.penulis.username }}</strong>
                                        </span>
                                        <span class="d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Dibuat {{ diskusi.created_at|date:'d M Y, H:i' }}">
                                            <i class="far fa-clock me-2"></i>
                                            {{ diskusi.created_at|timesince }} yang lalu
                                        </span>
                                        <span class="d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Total dilihat">
                                            <i class="far fa-eye me-2"></i>
                                            {{ diskusi.view_count }}
                                        </span>
                                    </div>
                                    
                                    <!-- Quick Action Buttons -->
                                    <div class="quick-actions">
                                        <a href="{% url 'forum:diskusi_detail' diskusi.slug %}" class="btn btn-sm btn-outline-success rounded-pill">
                                            <i class="fas fa-arrow-right me-1"></i>Baca
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar untuk engagement -->
                    <div class="engagement-bar"></div>
                </div>
                {% empty %}
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-5x text-muted mb-4 opacity-25"></i>
                        <h4 class="mb-3">Belum Ada Diskusi</h4>
                        <p class="text-muted mb-4">Jadilah yang pertama memulai diskusi di komunitas ini!</p>
                        <a href="{% url 'forum:diskusi_baru' %}" class="btn btn-success btn-lg">
                            <i class="fas fa-plus-circle me-2"></i>Mulai Diskusi Baru
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Forum Stats -->
            <div class="card border-0 shadow-sm mb-4" data-aos="fade-left">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">
                        <i class="fas fa-chart-line text-success me-2"></i>Statistik Forum
                    </h5>
                    <div class="stats-list">
                        <div class="stat-item d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div>
                                <i class="fas fa-comments text-success me-2"></i>
                                <span class="text-muted">Total Diskusi</span>
                            </div>
                            <span class="fw-bold fs-5 text-success">{{ page_obj.paginator.count|default:0 }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div>
                                <i class="fas fa-users text-success me-2"></i>
                                <span class="text-muted">Anggota Aktif</span>
                            </div>
                            <span class="fw-bold fs-5 text-success">{{ total_users|default:"0" }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-fire text-success me-2"></i>
                                <span class="text-muted">Topik Populer</span>
                            </div>
                            <span class="fw-bold fs-5 text-success">{{ trending_count|default:"0" }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forum Guidelines -->
            <div class="card border-0 shadow-sm mb-4 bg-success-subtle" data-aos="fade-left" data-aos-delay="100">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3 text-success">
                        <i class="fas fa-info-circle me-2"></i>Pedoman Forum
                    </h5>
                    <ul class="list-unstyled mb-0 small">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Bersikap sopan dan menghormati pendapat orang lain
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Gunakan bahasa yang baik dan benar
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Diskusi sesuai topik pengelolaan sampah
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Hindari spam dan konten yang tidak pantas
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Popular Topics -->
            <div class="card border-0 shadow-sm" data-aos="fade-left" data-aos-delay="200">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">
                        <i class="fas fa-fire text-success me-2"></i>Topik Populer
                    </h5>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">#PengelolaanSampah</span>
                                <span class="badge bg-success-subtle text-success">128</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">#Daur Ulang</span>
                                <span class="badge bg-success-subtle text-success">95</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">#BankSampah</span>
                                <span class="badge bg-success-subtle text-success">72</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AOS Animation -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init({
        duration: 600,
        once: true
    });
</script>

<style>
/* Modern Forum Header */
.forum-header {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    position: relative;
    overflow: hidden;
    padding: 4rem 0;
}

.forum-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.05)" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,149.3C960,160,1056,160,1152,138.7C1248,117,1344,75,1392,53.3L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
    background-size: cover;
}

.header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.1);
}

/* Enhanced Search Card */
.search-card {
    border-radius: 1rem;
    transition: all 0.3s ease;
}

.search-card:hover {
    box-shadow: 0 0.5rem 1.5rem rgba(25, 135, 84, 0.15) !important;
}

.search-card .form-control:focus {
    border-color: #198754;
    box-shadow: none;
}

/* Discussion Cards with Advanced Effects */
.discussion-card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 1rem;
    overflow: hidden;
    position: relative;
}

.discussion-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, #198754 0%, #20c997 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.discussion-card:hover::before {
    opacity: 1;
}

.discussion-card:hover {
    transform: translateY(-4px) translateX(4px);
    box-shadow: 0 1.5rem 3rem rgba(25, 135, 84, 0.2) !important;
}

/* Engagement Bar Animation */
.engagement-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #198754 0%, #20c997 100%);
    width: 0%;
    transition: width 0.6s ease-out;
}

.discussion-card:hover .engagement-bar {
    width: 100%;
}

/* Avatar Enhancements */
.discussion-avatar {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border: 3px solid #fff;
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
    transition: all 0.3s ease;
}

.discussion-card:hover .discussion-avatar {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.3);
}

.avatar-wrapper {
    position: relative;
}

.avatar-badge {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 16px;
    height: 16px;
    background: #198754;
    border: 2px solid #fff;
    border-radius: 50%;
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
    }
    50% {
        box-shadow: 0 0 0 6px rgba(25, 135, 84, 0);
    }
}

/* Link Animations */
.discussion-link {
    transition: all 0.3s ease;
    background: linear-gradient(to right, #198754 0%, #198754 100%);
    background-size: 0 2px;
    background-repeat: no-repeat;
    background-position: left bottom;
}

.discussion-link:hover {
    color: #198754 !important;
    background-size: 100% 2px;
}

/* Badge Enhancements */
.bg-success-subtle {
    background-color: rgba(25, 135, 84, 0.1);
    backdrop-filter: blur(10px);
}

.badge {
    font-weight: 500;
    letter-spacing: 0.5px;
}

/* Pulse Animation for Trending Badge */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.pulse {
    animation: pulse 2s infinite;
}

/* Quick Actions */
.quick-actions .btn {
    transition: all 0.3s ease;
}

.quick-actions .btn:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
}

/* Sorting Buttons */
.btn-group .btn {
    transition: all 0.3s ease;
}

.btn-group .btn.active {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
    border-color: #198754;
}

.btn-group .btn:hover:not(.active) {
    background-color: rgba(25, 135, 84, 0.1);
    border-color: #198754;
    color: #198754;
}

/* Input Focus Effects */
.input-group-lg .form-control {
    font-size: 1rem;
    transition: all 0.3s ease;
}

.input-group-lg .form-control:focus {
    transform: translateY(-2px);
}

/* Pagination Enhancements */
.page-link {
    border-radius: 0.5rem;
    margin: 0 0.25rem;
    border: none;
    color: #198754;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.page-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.page-link:hover::before {
    left: 100%;
}

.page-item.active .page-link {
    background: linear-gradient(135deg, #198754 0%, #20c997 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

.page-link:hover {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Sidebar Cards */
.stat-item {
    font-size: 0.9rem;
    transition: all 0.3s ease;
    padding: 0.75rem;
    border-radius: 0.5rem;
}

.stat-item:hover {
    background-color: rgba(25, 135, 84, 0.05);
    transform: translateX(5px);
}

/* Loading Animation */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.discussion-card {
    animation: fadeInUp 0.6s ease-out;
}

/* Responsive Adjustments */
@media (max-width: 991.98px) {
    .forum-header {
        padding: 3rem 0;
    }
    
    .discussion-card:hover {
        transform: translateY(-2px);
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .btn {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
}

/* Smooth Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #198754 0%, #20c997 100%);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #157347 0%, #198754 100%);
}

/* Skeleton Loading Effect */
@keyframes shimmer {
    0% {
        background-position: -1000px 0;
    }
    100% {
        background-position: 1000px 0;
    }
}

.loading-skeleton {
    animation: shimmer 2s infinite;
    background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
    background-size: 1000px 100%;
}

/* Glass Morphism Effects */
.glass-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Show success messages from Django
    {% if messages %}
    {% for message in messages %}
    showToast('{{ message }}', '{{ message.tags }}');
    {% endfor %}
    {% endif %}
    
    // Toast notification function
    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('successToast');
        const toastBody = document.getElementById('toastMessage');
        const toast = new bootstrap.Toast(toastEl, {
            animation: true,
            autohide: true,
            delay: 3000
        });
        
        // Update message and color based on type
        toastBody.textContent = message;
        toastEl.className = 'toast align-items-center text-white border-0';
        if (type.includes('error') || type.includes('danger')) {
            toastEl.classList.add('bg-danger');
        } else if (type.includes('warning')) {
            toastEl.classList.add('bg-warning');
        } else if (type.includes('info')) {
            toastEl.classList.add('bg-info');
        } else {
            toastEl.classList.add('bg-success');
        }
        
        toast.show();
    }
    
    // Calculate and animate engagement bars
    const discussionCards = document.querySelectorAll('.discussion-card');
    
    discussionCards.forEach(card => {
        const viewCount = parseInt(card.dataset.viewCount || 0);
        const commentCount = parseInt(card.dataset.commentCount || 0);
        const engagementBar = card.querySelector('.engagement-bar');
        
        if (engagementBar) {
            // Calculate engagement score (views + comments * 5)
            // Max score normalized to 100
            const maxScore = 200; // Adjustable threshold
            const score = Math.min(100, ((viewCount + (commentCount * 5)) / maxScore) * 100);
            
            // Animate the bar on card hover
            card.addEventListener('mouseenter', function() {
                engagementBar.style.width = score + '%';
            });
            
            card.addEventListener('mouseleave', function() {
                engagementBar.style.width = '0%';
            });
        }
    });
    
    // Smooth scroll to top on pagination
    const paginationLinks = document.querySelectorAll('.pagination .page-link');
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            if (!this.closest('.page-item').classList.contains('active')) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    });
    
    // Add ripple effect on cards
    discussionCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't trigger ripple if clicking on links or buttons
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
                return;
            }
            
            // Create ripple element
            const ripple = document.createElement('span');
            const rect = card.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple-effect');
            
            card.style.position = 'relative';
            card.style.overflow = 'hidden';
            card.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
            
            // Navigate to discussion after ripple animation starts
            setTimeout(() => {
                const link = card.querySelector('.discussion-link');
                if (link) {
                    window.location.href = link.href;
                }
            }, 200);
        });
    });
    
    // Enhanced avatar loading with fallback
    const avatars = document.querySelectorAll('.discussion-avatar');
    avatars.forEach(avatar => {
        avatar.addEventListener('error', function() {
            // Fallback to default avatar if image fails to load
            this.src = 'https://ui-avatars.com/api/?name=User&background=198754&color=fff&size=56&bold=true';
        });
    });
    
    // Auto-focus search input with keyboard shortcut (Ctrl+K or Cmd+K)
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.querySelector('input[name="q"]');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                showToast('Tekan Enter untuk mencari', 'info');
            }
        }
        
        // ESC to clear search
        if (e.key === 'Escape') {
            const searchInput = document.querySelector('input[name="q"]');
            if (searchInput && searchInput.value) {
                searchInput.value = '';
                searchInput.blur();
            }
        }
    });
    
    // Add loading state to search form
    const searchForm = document.querySelector('.search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                submitBtn.disabled = true;
                
                // Re-enable if form submission fails
                setTimeout(() => {
                    submitBtn.innerHTML = originalContent;
                    submitBtn.disabled = false;
                }, 5000);
            }
        });
    }
    
    // Lazy load discussion content on scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, {
        threshold: 0.1
    });
    
    discussionCards.forEach(card => {
        observer.observe(card);
    });
    
    // Show keyboard shortcut hints on first visit
    if (!localStorage.getItem('forum_hints_shown')) {
        setTimeout(() => {
            showToast('ðŸ’¡ Tip: Tekan Ctrl+K (atau Cmd+K) untuk fokus pencarian', 'info');
            localStorage.setItem('forum_hints_shown', 'true');
        }, 2000);
    }
    
    // Add quick navigation with number keys (1-9 for first 9 discussions)
    document.addEventListener('keydown', function(e) {
        if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key >= '1' && e.key <= '9') {
            // Don't trigger if typing in input field
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            
            const index = parseInt(e.key) - 1;
            const discussionLinks = document.querySelectorAll('.discussion-link');
            if (discussionLinks[index]) {
                window.location.href = discussionLinks[index].href;
            }
        }
    });
});

// Add CSS for ripple effect and visibility animations dynamically
const style = document.createElement('style');
style.textContent = `
    .ripple-effect {
        position: absolute;
        border-radius: 50%;
        background: rgba(25, 135, 84, 0.3);
        transform: scale(0);
        animation: ripple-animation 0.6s ease-out;
        pointer-events: none;
    }
    
    @keyframes ripple-animation {
        to {
            transform: scale(2);
            opacity: 0;
        }
    }
    
    .discussion-card {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .discussion-card.visible {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* Toast custom styles */
    .toast {
        min-width: 300px;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    
    /* Search input highlight */
    input[name="q"]:focus {
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25) !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
```